<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì§„íŠ¸ë¦¬ í‘œí˜„ ê°€ëŠ¥ì„± ì‹œê°í™”</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: #333;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            width: 100%;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .info-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
            font-family: monospace;
        }

        .step-info {
            margin: 5px 0;
        }

        .highlight {
            color: #d63384;
            font-weight: bold;
        }

        /* Tree Visualization */
        .tree-container {
            position: relative;
            height: 400px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            padding-top: 40px;
            background-color: #fff;
        }

        .node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            position: absolute;
            transition: all 0.5s;
            z-index: 2;
            border: 2px solid #ccc;
            background-color: white;
            color: #ccc;
        }

        .node.one {
            background-color: #4CAF50;
            color: white;
            border-color: #388E3C;
        }

        .node.zero {
            background-color: #f5f5f5;
            color: #bbb;
            border-color: #ddd;
            border-style: dashed;
        }

        /* Animation States */
        .node.checking {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
            border-color: #2196F3;
        }

        .node.error-parent {
            background-color: #ffcdd2;
            /* Red background for 0-prent */
            border-color: #f44336;
            color: #d32f2f;
        }

        .node.error-child {
            background-color: #ff5252;
            border-color: #b71c1c;
            color: white;
            animation: shake 0.5s;
        }

        .node.valid {
            border-width: 3px;
        }

        .edge {
            position: absolute;
            background-color: #eee;
            transform-origin: top left;
            z-index: 1;
            transition: background-color 0.3s;
        }

        .edge.checking {
            background-color: #2196F3;
            height: 2px !important;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .status-msg {
            margin-top: 20px;
            font-weight: bold;
            height: 24px;
        }

        .status-success {
            color: #2e7d32;
        }

        .status-fail {
            color: #c62828;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸŒ² í‘œí˜„ ê°€ëŠ¥í•œ ì´ì§„íŠ¸ë¦¬ ì‹œê°í™”</h1>

        <div class="input-group">
            <input type="number" id="inputNum" placeholder="ì‹­ì§„ìˆ˜ ì…ë ¥ (ì˜ˆ: 58)" value="58">
            <button onclick="initAndRun()">íŠ¸ë¦¬ ìƒì„±</button>
        </div>

        <div class="input-group">
            <button id="btnPrev" onclick="step(-1)" disabled>â—€ Prev</button>
            <button id="btnPlay" onclick="togglePlay()">â–¶ Play</button>
            <button id="btnNext" onclick="step(1)" disabled>Next â–¶</button>
        </div>

        <div class="info-panel" id="infoPanel">
            <div class="step-info">ìˆ«ìë¥¼ ì…ë ¥í•˜ê³  'íŠ¸ë¦¬ ìƒì„±'ì„ ëˆ„ë¥´ì„¸ìš”.</div>
        </div>

        <div class="legend">
            <div><span class="dot" style="background-color: #4CAF50;"></span>1 (ë…¸ë“œ ìˆìŒ)</div>
            <div><span class="dot" style="background-color: #f5f5f5; border: 1px dashed #ccc;"></span>0 (ë…¸ë“œ ì—†ìŒ)</div>
            <div><span class="dot" style="background-color: #2196F3;"></span>ê²€ì‚¬ ì¤‘</div>
            <div><span class="dot" style="background-color: #ff5252;"></span>ì˜¤ë¥˜ (ë¶€ëª¨0-ìì‹1)</div>
        </div>

        <div class="tree-container" id="treeContainer"></div>
        <div class="status-msg" id="statusMsg"></div>

        <div style="margin-top: 10px;">
            <label>ì†ë„: <input type="range" id="speed" min="100" max="2000" step="100" value="800"
                    oninput="updateSpeed(this.value)"></label>
            <span id="speedVal">0.8s</span>
        </div>
    </div>

    <script>
        let animationSpeed = 800;
        let isPlaying = false;
        let playTimer = null;
        let steps = [];
        let currentStepIdx = -1;
        let map = []; // Node map
        let paddedBinGlobal = "";

        function updateSpeed(val) {
            animationSpeed = 2100 - val;
            document.getElementById('speedVal').innerText = (animationSpeed / 1000).toFixed(1) + 's';
        }

        // ì´ˆê¸°í™” ë° íŠ¸ë¦¬ ê·¸ë¦¬ê¸°
        function initAndRun() {
            stopPlay();
            currentStepIdx = -1;
            steps = [];
            map = [];

            const numInput = document.getElementById('inputNum').value;
            const num = BigInt(numInput);
            const infoPanel = document.getElementById('infoPanel');
            const treeContainer = document.getElementById('treeContainer');
            const statusMsg = document.getElementById('statusMsg');

            treeContainer.innerHTML = '';
            statusMsg.innerText = '';
            statusMsg.className = 'status-msg';

            // 1. ì´ì§„ìˆ˜ ë³€í™˜
            let binStr = num.toString(2);
            let len = binStr.length;

            // 2. íŒ¨ë”© ê³„ì‚°
            let h = 0;
            while ((Math.pow(2, h) - 1) < len) {
                h++;
            }
            let fullLen = Math.pow(2, h) - 1;
            let paddedBin = binStr.padStart(fullLen, '0');
            paddedBinGlobal = paddedBin;

            // ì •ë³´ í‘œì‹œ
            infoPanel.innerHTML = `
                <div class="step-info">1. ì‹­ì§„ìˆ˜: <span class="highlight">${num}</span></div>
                <div class="step-info">2. ì´ì§„ìˆ˜: <span class="highlight">${binStr}</span> (ê¸¸ì´: ${len})</div>
                <div class="step-info">3. í¬í™” ì´ì§„íŠ¸ë¦¬ ê¸¸ì´: <span class="highlight">${fullLen}</span> (ë†’ì´: ${h})</div>
                <div class="step-info">4. íŒ¨ë”© ê²°ê³¼: <span class="highlight">${paddedBin}</span></div>
            `;

            // íŠ¸ë¦¬ ê·¸ë¦¬ê¸°
            const width = treeContainer.offsetWidth;
            const initialDx = width / 4;

            drawNode(0, fullLen - 1, 1, width / 2 - 20, 20, initialDx, paddedBin);
            drawEdges(0, fullLen - 1, 1, null, null, initialDx);

            // ê²€ì‚¬ ë‹¨ê³„(Steps) ë¯¸ë¦¬ ìƒì„±
            generateSteps(0, fullLen - 1, '1'); // ê°€ìƒ ë¶€ëª¨ '1'

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateButtons();
        }

        function drawNode(start, end, level, x, y, dx, paddedBin) {
            if (start > end) return;

            const mid = Math.floor((start + end) / 2);
            const val = paddedBin[mid];

            const nodeEl = document.createElement('div');
            nodeEl.className = `node ${val === '1' ? 'one' : 'zero'}`;
            nodeEl.innerText = mid;
            nodeEl.style.left = `${x}px`;
            nodeEl.style.top = `${y}px`;

            document.getElementById('treeContainer').appendChild(nodeEl);
            map[mid] = { el: nodeEl, val: val, x: x, y: y };

            const nextY = y + 60;
            const nextDx = dx / 2;

            drawNode(start, mid - 1, level + 1, x - dx, nextY, nextDx, paddedBin);
            drawNode(mid + 1, end, level + 1, x + dx, nextY, nextDx, paddedBin);
        }

        function drawEdges(start, end, level, parentX, parentY, dx) {
            if (start > end) return;
            const mid = Math.floor((start + end) / 2);

            if (parentX !== null) {
                const edge = document.createElement('div');
                edge.className = 'edge';

                const deltaX = (map[mid].x + 20) - (parentX + 20);
                const deltaY = (map[mid].y + 20) - (parentY + 20);
                const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

                edge.style.width = `${dist}px`;
                edge.style.height = `1px`;
                edge.style.left = `${parentX + 20}px`;
                edge.style.top = `${parentY + 20}px`;
                edge.style.transform = `rotate(${angle}deg)`;

                const container = document.getElementById('treeContainer');
                container.insertBefore(edge, container.firstChild);
            }

            const nextDx = dx / 2;
            drawEdges(start, mid - 1, level + 1, map[mid].x, map[mid].y, nextDx);
            drawEdges(mid + 1, end, level + 1, map[mid].x, map[mid].y, nextDx);
        }

        // ê²€ì‚¬ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜ ë° ë‹¨ê³„ ê¸°ë¡
        function generateSteps(start, end, parentVal) {
            if (start > end) return true;

            const mid = Math.floor((start + end) / 2);
            const currentVal = paddedBinGlobal[mid];

            // Step: Checking start
            steps.push({
                type: 'check_start',
                nodeIdx: mid,
                msg: `Node[${mid}] ê²€ì‚¬: ê°’=${currentVal}, ë¶€ëª¨=${parentVal}`
            });

            // ê·œì¹™ ê²€ì‚¬
            if (parentVal === '0' && currentVal === '1') {
                steps.push({
                    type: 'error',
                    nodeIdx: mid,
                    msg: `ì˜¤ë¥˜ ë°œê²¬! ë¶€ëª¨ê°€ 0ì¸ë° ìì‹(Node[${mid}])ì´ 1ì…ë‹ˆë‹¤.`
                });
                return false;
            }

            // Step: Node Validated (temporarily, pending children)
            steps.push({
                type: 'mark_valid',
                nodeIdx: mid,
                msg: `Node[${mid}] í†µê³¼. ìì‹ ê²€ì‚¬ ì§„í–‰...`
            });

            // ìì‹ ê²€ì‚¬
            const leftRes = generateSteps(start, mid - 1, currentVal); // ì™¼ìª½ ìì‹ì—ê²Œ í˜„ì¬ ê°’ì„ ë¶€ëª¨ê°’ìœ¼ë¡œ ì „ë‹¬
            // ë§Œì•½ ì™¼ìª½ì—ì„œ ì‹¤íŒ¨í–ˆë”ë¼ë„ ì „ì²´ ê³¼ì •ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ê³„ì† ì§„í–‰í• ì§€, ì¤‘ë‹¨í• ì§€ ê²°ì •
            // ì—¬ê¸°ì„œëŠ” ë¬¸ì œ í’€ì´ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ Falseë©´ ì¦‰ì‹œ ì¤‘ë‹¨ë˜ëŠ” íë¦„(AND ì—°ì‚°)ì„ ë”°ë¥´ë˜,
            // ì‹œê°í™”ì—ì„œëŠ” ì—ëŸ¬ ë‚œ ê³³ì„ ë³´ì—¬ì£¼ê³  ë©ˆì¶”ëŠ” ê²Œ ë‚˜ìŒ.
            if (!leftRes) return false;

            const rightRes = generateSteps(mid + 1, end, currentVal);
            if (!rightRes) return false;

            return true;
        }

        // --- ì¬ìƒ ë° ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ ---

        function togglePlay() {
            if (isPlaying) stopPlay();
            else startPlay();
        }

        function startPlay() {
            if (currentStepIdx >= steps.length - 1) {
                // ì´ë¯¸ ëì´ë©´ ì²˜ìŒë¶€í„°? í˜¹ì€ ë¦¬ì…‹
                if (currentStepIdx > -1) resetVis(); // Reset if not initial state
            }
            isPlaying = true;
            document.getElementById('btnPlay').innerText = "â¸ Pause";
            runTimer();
        }

        function stopPlay() {
            isPlaying = false;
            document.getElementById('btnPlay').innerText = "â–¶ Play";
            if (playTimer) clearTimeout(playTimer);
            playTimer = null;
        }

        function runTimer() {
            if (!isPlaying) return;
            if (currentStepIdx < steps.length - 1) {
                step(1);
                playTimer = setTimeout(runTimer, animationSpeed);
            } else {
                stopPlay();
            }
        }

        function step(dir) {
            const nextIdx = currentStepIdx + dir;
            if (nextIdx < -1 || nextIdx >= steps.length) return;

            if (dir > 0) {
                // Forward: Apply next step
                applyStep(steps[nextIdx]);
            } else {
                // Backward: Revert current step
                revertStep(steps[currentStepIdx]);
            }
            currentStepIdx = nextIdx;
            updateButtons();
        }

        function applyStep(s) {
            const node = map[s.nodeIdx].el;
            const msgPanel = document.getElementById('statusMsg');

            msgPanel.innerText = s.msg;

            if (s.type === 'check_start') {
                node.classList.add('checking');
            } else if (s.type === 'error') {
                node.classList.remove('checking');
                node.classList.add('error-child');
                msgPanel.className = "status-msg status-fail";
            } else if (s.type === 'mark_valid') {
                node.classList.remove('checking');
                node.classList.add('valid');
            }
        }

        function revertStep(s) {
            const node = map[s.nodeIdx].el;
            const msgPanel = document.getElementById('statusMsg');
            msgPanel.innerText = "";
            msgPanel.className = "status-msg";

            if (s.type === 'check_start') {
                node.classList.remove('checking');
            } else if (s.type === 'error') {
                node.classList.remove('error-child');
                // Revert to checking state of this node, which was the previous step
                node.classList.add('checking');
            } else if (s.type === 'mark_valid') {
                node.classList.remove('valid');
                // Revert to checking state, which was the previous step
                node.classList.add('checking');
            }

            // ì´ì „ ìŠ¤í…ì˜ ë©”ì‹œì§€ ë³µì›ì´ í•„ìš”í•  ìˆ˜ ìˆì§€ë§Œ, ê°„ë‹¨íˆ ë¹„ì›€.
            // ì •í™•í•œ ì—­ë°©í–¥ ì§„í–‰ì„ ìœ„í•´ì„œëŠ” ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì´ í•„ìš”í•˜ë‚˜,
            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ í´ë˜ìŠ¤ í† ê¸€ ì—­ì—°ì‚°ìœ¼ë¡œ ì²˜ë¦¬. 
            // ë‹¨, ì—°ì†ëœ ìŠ¤í…ì—ì„œ ìƒíƒœê°€ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ í•„ìš”.
            // checking -> valid ìˆœì„œì´ë¯€ë¡œ, validë¥¼ revertí•˜ë©´ checkingì´ ë˜ì–´ì•¼ í•¨.
        }

        // ì—­ë°©í–¥ ì‹œ ì™„ë²½í•œ ìƒíƒœ ë³µì›ì„ ìœ„í•´ reset í›„ fast-forwardê°€ ì•ˆì „í•˜ì§€ë§Œ,
        // ì„±ëŠ¥ìƒ ë‹¨ìˆœ í´ë˜ìŠ¤ ì¡°ì‘ìœ¼ë¡œ êµ¬í˜„.
        // ë¬¸ì œì : 'mark_valid'ë¥¼ revertí•˜ë©´ 'check_start' ìƒíƒœ(checking í´ë˜ìŠ¤)ë¡œ ëŒì•„ê°€ì•¼ í•¨.
        // í˜„ì¬ ë¡œì§ì— ì¶”ê°€í•¨.

        function resetVis() {
            stopPlay();
            currentStepIdx = -1;
            // ëª¨ë“  ë…¸ë“œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            for (let i in map) {
                map[i].el.className = `node ${map[i].val === '1' ? 'one' : 'zero'}`;
            }
            document.getElementById('statusMsg').innerText = "";
            document.getElementById('statusMsg').className = "status-msg";
            updateButtons();
        }

        function updateButtons() {
            document.getElementById('btnPrev').disabled = currentStepIdx < 0;
            document.getElementById('btnNext').disabled = currentStepIdx >= steps.length - 1;

            // ë§ˆì§€ë§‰ ìŠ¤í… ë„ë‹¬ ì‹œ ê²°ê³¼ ë©”ì‹œì§€ ê³ ì •
            if (currentStepIdx === steps.length - 1 && steps.length > 0) {
                const lastStep = steps[steps.length - 1];
                if (lastStep.type !== 'error') {
                    document.getElementById('statusMsg').innerHTML = "âœ… ê²€ì‚¬ ì™„ë£Œ: í‘œí˜„ ê°€ëŠ¥í•œ ì´ì§„íŠ¸ë¦¬ì…ë‹ˆë‹¤!";
                    document.getElementById('statusMsg').className = "status-msg status-success";
                }
            }
        }
    </script>
</body>

</html>